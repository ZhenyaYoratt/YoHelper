from PyQt5.QtCore import Qt
from PyQt5.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QLabel, QLineEdit, QPushButton, QFileDialog, QStackedWidget,
    QTableWidget, QTableWidgetItem, QMessageBox, QHeaderView,
    QAbstractItemView, QDesktopWidget
)
import qtawesome
import os, subprocess

from modules.monitor import *

class ProcessMonitorWindow(QMainWindow):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("–ú–æ–Ω–∏—Ç–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞")
        self.resize(600, 150)

        self.thread = None

        # Stacked widget
        self.stack = QStackedWidget()
        self.setCentralWidget(self.stack)

        # Page select
        self.page_select = QWidget(); self._build_select_page(); self.stack.addWidget(self.page_select)
        # Page monitor
        self.page_monitor = QWidget(); self._build_monitor_page(); self.stack.addWidget(self.page_monitor)
        self.stack.setCurrentWidget(self.page_select)

    def _build_select_page(self):
        layout = QVBoxLayout()
        self.page_select.setLayout(layout)
        layout.addStretch()

        top = QLabel("–í—ã–±–µ—Ä–∏—Ç–µ .exe —Ñ–∞–π–ª –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–ú–æ–Ω–∏—Ç–æ—Ä –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –¥–æ—á–µ—Ä–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–µ –∏–º–∏ —Ñ–∞–π–ª—ã/–ø–∞–ø–∫–∏)")
        top.setWordWrap(True)
        top.setAlignment(Qt.AlignCenter)
        layout.addWidget(top)

        file_h = QHBoxLayout()
        self.file_input = QLineEdit()
        self.file_input.setPlaceholderText("–ü—É—Ç—å –∫ .exe —Ñ–∞–π–ª—É")
        browse_btn = QPushButton("–û–±–∑–æ—Ä")
        browse_btn.clicked.connect(self.browse_file)
        file_h.addWidget(self.file_input)
        file_h.addWidget(browse_btn)
        layout.addLayout(file_h)

        uac_h = QHBoxLayout()
        self.uac_label = QLabel("")  # shield
        uac_h.addWidget(self.uac_label)
        uac_h.addStretch()
        layout.addLayout(uac_h)

        start_btn = QPushButton("–ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥")
        start_btn.clicked.connect(self.start_monitoring)
        layout.addWidget(start_btn)

        layout.addStretch()

        self.file_input.textChanged.connect(self.update_uac_icon)

    def _build_monitor_page(self):
        layout = QVBoxLayout()
        self.page_monitor.setLayout(layout)

        top_h = QHBoxLayout()
        self.status_label = QLabel("–û–∂–∏–¥–∞–Ω–∏–µ")
        top_h.addWidget(self.status_label)
        top_h.addStretch()
        stop_btn = QPushButton("–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥")
        stop_btn.clicked.connect(self.stop_monitoring)
        top_h.addWidget(stop_btn)
        layout.addLayout(top_h)

        # Table columns: Date/time (grey), +time (s) dark green, Action, Path (full), Risk %, Actions (buttons)
        self.table = QTableWidget()
        self.table.setColumnCount(6)
        self.table.setHorizontalHeaderLabels(["–í—Ä–µ–º—è", "+—Å–µ–∫", "–î–µ–π—Å—Ç–≤–∏–µ", "–ü—É—Ç—å", "–†–∏—Å–∫", "–î–µ–π—Å—Ç–≤–∏—è"])
        self.table.verticalHeader().setVisible(False)  # remove row numbers
        self.table.setEditTriggers(QAbstractItemView.EditTrigger.DoubleClicked)
        self.table.setSelectionBehavior(QAbstractItemView.SelectionBehavior.SelectRows)
        header = self.table.horizontalHeader()
        header.setSectionResizeMode(0, QHeaderView.ResizeMode.ResizeToContents)
        header.setSectionResizeMode(1, QHeaderView.ResizeMode.ResizeToContents)
        header.setSectionResizeMode(2, QHeaderView.ResizeMode.Custom)
        header.resizeSection(2, 150)
        header.setSectionResizeMode(3, QHeaderView.Stretch)
        header.setSectionResizeMode(4, QHeaderView.ResizeToContents)
        header.setSectionResizeMode(5, QHeaderView.ResizeToContents)
        # compact rows
        self.table.setStyleSheet("QTableWidget::item { padding: 2px; }")
        layout.addWidget(self.table)

    def browse_file(self):
        p, _ = QFileDialog.getOpenFileName(self, "–í—ã–±–µ—Ä–∏—Ç–µ .exe", "", "Executable (*.exe);;All files (*.*)")
        if p:
            self.file_input.setText(p)

    def update_uac_icon(self):
        path = self.file_input.text().strip()
        if path and os.path.isfile(path) and requires_elevation_exe(path):
            self.uac_label.setText("üõ° –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫ –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
        else:
            self.uac_label.setText("")

    def start_monitoring(self):
        exe_path = self.file_input.text().strip()
        if not exe_path or not os.path.isfile(exe_path):
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π .exe —Ñ–∞–π–ª.")
            return
        need_elev = requires_elevation_exe(exe_path)
        if need_elev:
            ans = QMessageBox.question(self, "–¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",
                                       "–§–∞–π–ª, –ø–æ –≤—Å–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏, —Ç—Ä–µ–±—É–µ—Ç –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∞–≤. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø–æ–≤—ã—à–µ–Ω–∏–µ–º?",
                                       QMessageBox.Yes | QMessageBox.No)
            if ans != QMessageBox.Yes:
                return

        self.resize(1400, 800)
        qr = self.frameGeometry()  
        cp = QDesktopWidget().availableGeometry().center()  
        qr.moveCenter(cp)  
        self.move(qr.topLeft())

        # prepare watch dirs: exe directory, TEMP, Desktop, APPDATA
        watch_dirs = []
        try:
            ed = os.path.dirname(exe_path)
            if ed: watch_dirs.append(ed)
            t = os.environ.get("TEMP", "")
            if t: watch_dirs.append(t)
            desk = os.path.join(os.environ.get("USERPROFILE", ""), "Desktop")
            if desk: watch_dirs.append(desk)
            ad = os.environ.get("APPDATA", "")
            if ad: watch_dirs.append(ad)
        except Exception:
            pass
        watch_dirs = [d for d in watch_dirs if d and os.path.exists(d)]

        # switch UI
        self.table.setRowCount(0)
        self.status_label.setText("–ó–∞–ø—É—Å–∫...")
        self.stack.setCurrentWidget(self.page_monitor)

        # start thread
        self.thread = MonitorThread(exe_path, require_elevate=need_elev, watch_dirs=watch_dirs)
        self.thread.event_signal.connect(self.on_log_event)
        self.thread.status_signal.connect(self.status_label.setText)
        self.thread.finished_signal.connect(self.on_monitor_finished)
        self.thread.start()
        # initial message
        self.add_table_row({
            "time": now_str(),
            "since": 0,
            "action": "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω",
            "path": exe_path,
            "pid": None,
            "risk": 0
        })

    def stop_monitoring(self):
        if hasattr(self, "thread") and self.thread:
            try:
                self.thread.stop()
            except Exception:
                pass

        self.stack.setCurrentWidget(self.page_select)
        self.status_label.setText("–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ)")
        self.resize(600, 150)
        qr = self.frameGeometry()
        cp = QDesktopWidget().availableGeometry().center()
        qr.moveCenter(cp)
        self.move(qr.topLeft())

    def on_monitor_finished(self):
        self.add_table_row({
            "time": now_str(),
            "since": round(seconds_since(self.thread.start_ts), 3) if getattr(self.thread, "start_ts", None) else 0.000,
            "action": "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω",
            "path": "",
            "pid": None,
            "risk": 0
        })
        self.status_label.setText("–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

    def on_log_event(self, ev):
        # ev is dict: time, since, action, path, pid, extra, risk
        self.add_table_row(ev)

    def add_table_row(self, ev):
        row = self.table.rowCount()
        self.table.insertRow(row)
        # Date/time (grey)
        item_time = QTableWidgetItem(ev.get("time", now_str()))
        item_time.setForeground(QBrush(QColor(120, 120, 120)))
        item_time.setFlags(item_time.flags() ^ Qt.ItemIsEditable)
        self.table.setItem(row, 0, item_time)
        # +time (dark green)
        item_since = QTableWidgetItem(str(ev.get("since", '')))
        item_since.setForeground(QBrush(QColor(0, 100, 0)))
        item_since.setFlags(item_since.flags() ^ Qt.ItemIsEditable)
        self.table.setItem(row, 1, item_since)
        # Action
        item_act = QTableWidgetItem(ev.get("action", ""))
        item_act.setFlags(item_act.flags() ^ Qt.ItemIsEditable)
        self.table.setItem(row, 2, item_act)
        # Path full
        path_txt = ev.get("path", "") or ""
        item_path = QTableWidgetItem(path_txt)
        item_path.setFlags(item_path.flags() ^ Qt.ItemIsEditable)
        self.table.setItem(row, 3, item_path)
        # Risk percent with background
        risk = int(ev.get("risk", 0))
        item_risk = QTableWidgetItem(str(risk) + "%")
        item_risk.setFlags(item_risk.flags() ^ Qt.ItemIsEditable)
        item_risk.setBackground(risk_brush(risk))
        self.table.setItem(row, 4, item_risk)
        # Actions column (buttons)
        action_widget = QWidget()
        ah = QHBoxLayout()
        ah.setContentsMargins(0, 0, 0, 0)
        ah.setSpacing(4)
        # depending on action, add appropriate buttons
        if ev.get("action", "").startswith("–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª") or ev.get("action", "").startswith("–°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞"):
            # open folder + copy path
            btn_open = QPushButton()
            btn_open.setIcon(qtawesome.icon("mdi.folder"))
            btn_open.setProperty("path", path_txt)
            btn_open.clicked.connect(lambda _, p=path_txt: self.open_folder(p))
            btn_copy = QPushButton()
            btn_copy.setIcon(qtawesome.icon("mdi.content-copy"))
            btn_copy.clicked.connect(lambda _, p=path_txt: self.copy_path(p))
            ah.addWidget(btn_open)
            ah.addWidget(btn_copy)
        elif ev.get("action", "").startswith("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ") or "–∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞" in ev.get("action", "").lower() or ev.get("action", "").startswith("–£–¥–∞–ª—ë–Ω –∫–ª—é—á"):
            # registry buttons
            btn_openreg = QPushButton()
            btn_openreg.setIcon(qtawesome.icon("mdi.cube-off-outline"))
            btn_openreg.clicked.connect(lambda _, p=path_txt: self.open_regedit(p))
            btn_copy = QPushButton()
            btn_copy.setIcon(qtawesome.icon("mdi.content-copy"))
            btn_copy.clicked.connect(lambda _, p=path_txt: self.copy_path(p))
            ah.addWidget(btn_openreg)
            ah.addWidget(btn_copy)
        elif ev.get("action", "").lower().startswith("—Å–æ–∑–¥–∞–Ω –ø—Ä–æ—Ü–µ—Å—Å") or ev.get("action", "").lower().startswith("–ø—Ä–æ—Ü–µ—Å—Å"):
            btn_copy = QPushButton()
            btn_copy.setIcon(qtawesome.icon("mdi.content-copy"))
            btn_copy.clicked.connect(lambda _, p=path_txt: self.copy_path(p))
            ah.addWidget(btn_copy)
        else:
            # default: copy
            if path_txt:
                btn_copy = QPushButton()
                btn_copy.setIcon(qtawesome.icon("mdi.content-copy"))
                btn_copy.clicked.connect(lambda _, p=path_txt: self.copy_path(p))
                ah.addWidget(btn_copy)

        action_widget.setLayout(ah)
        self.table.setCellWidget(row, 5, action_widget)

        # compact row height
        self.table.setRowHeight(row, 26)
        # autoscroll
        self.table.scrollToBottom()

    # action handlers
    def open_folder(self, path):
        """
        –ï—Å–ª–∏ path —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ñ–∞–π–ª ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç –ü—Ä–æ–≤–æ–¥–Ω–∏–∫ –∏ –≤—ã–¥–µ–ª–∏—Ç —Ñ–∞–π–ª.
        –ï—Å–ª–∏ path —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–∞–ø–∫—É ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç —ç—Ç—É –ø–∞–ø–∫—É.
        """
        if not path:
            return
        # –ï—Å–ª–∏ path ‚Äî –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π, –ø–æ–ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –ø–∞–ø–∫—É
        if os.path.isdir(path):
            folder = path
            try:
                os.startfile(folder)
            except Exception as e:
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É:\n{e}")
            return

        # –µ—Å–ª–∏ —ç—Ç–æ —Ñ–∞–π–ª (–∏–ª–∏ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É)
        folder = os.path.dirname(path)
        if not folder or not os.path.exists(folder):
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", f"–ü—É—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω: {path}")
            return

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º explorer.exe —Å –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º /select,"<path>"
        try:
            # Make sure path is absolute and properly quoted
            abspath = os.path.abspath(path)
            subprocess.Popen(['explorer', '/select,', abspath])
        except Exception as e:
            # fallback: –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É
            try:
                os.startfile(folder)
            except Exception:
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É –∏–ª–∏ –≤—ã–¥–µ–ª–∏—Ç—å —Ñ–∞–π–ª:\n{e}")

    def copy_path(self, path):
        QApplication.clipboard().setText(path)
        QMessageBox.information(self, "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ", "–ü—É—Ç—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.")

    def open_regedit(self, path):
        # Best-effort: open regedit. Selecting exact key programmatically is non-trivial; here we just open regedit.
        try:
            subprocess.Popen(["regedit.exe"])
            QMessageBox.information(self, "Regedit", "Regedit –æ—Ç–∫—Ä—ã—Ç ‚Äî —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—É—Ç—å –∏ –Ω–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–π –∫–ª—é—á –≤—Ä—É—á–Ω—É—é.")
        except Exception as e:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å regedit:\n{e}")